<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Envoy Prometheus Exporter</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255,255,255,0.18);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .version-info {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 0.9em;
            padding: 10px;
            background: rgba(52, 73, 94, 0.1);
            border-radius: 8px;
        }
        .version-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .version-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }
        .version-label {
            font-weight: 500;
            color: #34495e;
        }
        .version-value {
            font-family: 'Courier New', monospace;
            color: #27ae60;
            font-size: 0.9em;
        }
        .endpoints { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
        }
        .endpoint-card { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .endpoint-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        .endpoint-card h3 { 
            margin-top: 0; 
            color: #2c3e50; 
            font-size: 1.3em;
            margin-bottom: 15px;
        }
        .endpoint-card p {
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .endpoint-card a { 
            display: inline-block; 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white; 
            padding: 12px 24px; 
            text-decoration: none; 
            border-radius: 6px; 
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .endpoint-card a:hover { 
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            transform: translateY(-2px);
        }
        .monitor-link { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important; 
        }
        .monitor-link:hover { 
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%) !important; 
        }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
        }
        .info-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            padding: 20px; 
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .info-card h4 { 
            margin-top: 0; 
            color: #2c3e50; 
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6c757d;
            font-weight: 500;
        }
        .info-value {
            color: #2c3e50;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
        .status-unknown { background-color: #f39c12; }
        .footer {
            margin-top: 40px; 
            padding-top: 20px; 
            border-top: 1px solid rgba(0,0,0,0.1); 
            text-align: center; 
            color: #7f8c8d;
        }
        .footer p {
            margin: 5px 0;
        }
        .footer .build-info {
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #95a5a6;
            margin-top: 10px;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
        }
        .success {
            color: #27ae60;
        }
        @media (max-width: 768px) {
            .container { padding: 20px; margin: 10px; }
            h1 { font-size: 2em; }
            .endpoints { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .version-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåû Enhanced Envoy Prometheus Exporter</h1>
        
        <div class="version-info">
            <div id="versionSummary" class="loading">Loading version information...</div>
            <div class="version-details" id="versionDetails" style="display: none;">
                <div class="version-item">
                    <span class="version-label">Version:</span>
                    <span class="version-value" id="version">--</span>
                </div>
                <div class="version-item">
                    <span class="version-label">Git Commit:</span>
                    <span class="version-value" id="gitCommit">--</span>
                </div>
                <div class="version-item">
                    <span class="version-label">Build Time:</span>
                    <span class="version-value" id="buildTime">--</span>
                </div>
                <div class="version-item">
                    <span class="version-label">Go Version:</span>
                    <span class="version-value" id="goVersion">--</span>
                </div>
                <div class="version-item">
                    <span class="version-label">Platform:</span>
                    <span class="version-value" id="platform">--</span>
                </div>
                <div class="version-item">
                    <span class="version-label">Uptime:</span>
                    <span class="version-value" id="uptime">--</span>
                </div>
            </div>
        </div>
        
        <div class="endpoints">
            <div class="endpoint-card">
                <h3>üìä Live Monitor</h3>
                <p>Real-time solar production dashboard with live data, solar position, and daily production graphs</p>
                <a href="/monitor.html" class="monitor-link">Open Monitor</a>
            </div>
            <div class="endpoint-card">
                <h3>üìà Prometheus Metrics</h3>
                <p>Raw metrics endpoint for Prometheus scraping with build information</p>
                <a href="/metrics">View Metrics</a>
            </div>
            <div class="endpoint-card">
                <h3>‚ù§Ô∏è Health Check</h3>
                <p>System health, component status, and uptime information</p>
                <a href="/health">Check Health</a>
            </div>
            <div class="endpoint-card">
                <h3>üîß Debug Info</h3>
                <p>Detailed diagnostics, build info, and troubleshooting</p>
                <a href="/debug">Debug Info</a>
            </div>
            <div class="endpoint-card">
                <h3>üì° API Endpoints</h3>
                <p>JSON APIs for integration and monitoring</p>
                <a href="/api/monitor">Monitor API</a>
                <a href="/api/version">Version API</a>
            </div>
            <div class="endpoint-card">
                <h3>‚ÑπÔ∏è Version Info</h3>
                <p>Detailed build and runtime version information</p>
                <a href="/version">Text Version</a>
                <a href="/api/version">JSON Version</a>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h4>üè† System Information</h4>
                <div class="info-row">
                    <span class="info-label">Envoy IP:</span>
                    <span class="info-value" id="envoyIP">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Port:</span>
                    <span class="info-value" id="port">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Location:</span>
                    <span class="info-value" id="location">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Uptime:</span>
                    <span class="info-value" id="systemUptime">Loading...</span>
                </div>
            </div>
            
            <div class="info-card">
                <h4>‚öôÔ∏è Configuration</h4>
                <div class="info-row">
                    <span class="info-label">Queries:</span>
                    <span class="info-value" id="queryCount">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total Metrics:</span>
                    <span class="info-value" id="metricCount">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Calculated Metrics:</span>
                    <span class="info-value" id="calcMetricCount">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Production Tracking:</span>
                    <span class="info-value" id="productionTracking">Loading...</span>
                </div>
            </div>

            <div class="info-card">
                <h4>üì° MQTT Publishing</h4>
                <div class="info-row">
                    <span class="info-label">Status:</span>
                    <span class="info-value" id="mqttStatus">
                        <span class="status-indicator status-unknown"></span>
                        Loading...
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Broker:</span>
                    <span class="info-value" id="mqttBroker">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Topic Prefix:</span>
                    <span class="info-value" id="mqttTopic">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Interval:</span>
                    <span class="info-value" id="mqttInterval">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Publish:</span>
                    <span class="info-value" id="mqttLastPublish">Loading...</span>
                </div>
            </div>

            <div class="info-card">
                <h4>üèóÔ∏è Build Information</h4>
                <div class="info-row">
                    <span class="info-label">Version:</span>
                    <span class="info-value" id="buildVersion">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Git Commit:</span>
                    <span class="info-value" id="buildCommit">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Built On:</span>
                    <span class="info-value" id="buildHost">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Go Runtime:</span>
                    <span class="info-value" id="goRuntime">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Memory Usage:</span>
                    <span class="info-value" id="memoryUsage">Loading...</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>Enhanced Configuration-Driven Envoy Prometheus Exporter</strong></p>
            <p>Real-time monitoring ‚Ä¢ Solar position tracking ‚Ä¢ Daily production graphs ‚Ä¢ MQTT publishing ‚Ä¢ Comprehensive diagnostics</p>
            <div class="build-info" id="footerBuildInfo">
                Loading build information...
            </div>
        </div>
    </div>

    <script>
        let versionData = null;

        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            const days = Math.floor(seconds / (24 * 3600));
            const hours = Math.floor((seconds % (24 * 3600)) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === 0) return 'Never';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            
            if (diffSeconds < 60) {
                return `${diffSeconds}s ago`;
            } else if (diffSeconds < 3600) {
                return `${Math.floor(diffSeconds / 60)}m ago`;
            } else {
                return date.toLocaleString();
            }
        }

        async function loadVersionInfo() {
            try {
                const response = await fetch('/api/version');
                if (!response.ok) throw new Error('Failed to fetch version info');
                
                const data = await response.json();
                versionData = data;
                
                const buildInfo = data.build_info;
                const runtimeInfo = data.runtime_info;
                const configInfo = data.config_info;
                
                // Update version summary
                document.getElementById('versionSummary').innerHTML = 
                    `<strong>${buildInfo.version}</strong> (${buildInfo.git_commit}) built ${formatTimestamp(new Date(buildInfo.build_time_utc).getTime() / 1000)}`;
                
                // Update detailed version info
                document.getElementById('version').textContent = buildInfo.version;
                document.getElementById('gitCommit').textContent = buildInfo.git_commit;
                document.getElementById('buildTime').textContent = new Date(buildInfo.build_time_utc).toLocaleString();
                document.getElementById('goVersion').textContent = buildInfo.go_runtime;
                document.getElementById('platform').textContent = buildInfo.platform;
                document.getElementById('uptime').textContent = formatDuration(Math.floor(new Date() - new Date(buildInfo.start_time)) / 1000);
                
                // Update system info
                document.getElementById('envoyIP').textContent = configInfo.envoy_ip;
                document.getElementById('port').textContent = configInfo.port;
                document.getElementById('location').textContent = 'Configured';
                document.getElementById('systemUptime').textContent = buildInfo.uptime;
                
                // Update configuration info
                document.getElementById('queryCount').textContent = configInfo.queries;
                document.getElementById('metricCount').textContent = 'Configured';
                document.getElementById('calcMetricCount').textContent = configInfo.calculated_metrics;
                document.getElementById('productionTracking').innerHTML = 
                    `<span class="status-indicator ${configInfo.production_tracking ? 'status-online' : 'status-offline'}"></span>${configInfo.production_tracking ? 'Enabled' : 'Disabled'}`;
                
                // Update build info
                document.getElementById('buildVersion').textContent = buildInfo.version;
                document.getElementById('buildCommit').textContent = buildInfo.git_commit;
                document.getElementById('buildHost').textContent = `${buildInfo.build_user}@${buildInfo.build_host}`;
                document.getElementById('goRuntime').textContent = buildInfo.go_runtime;
                document.getElementById('memoryUsage').textContent = formatBytes(runtimeInfo.memory_alloc);
                
                // Update footer
                document.getElementById('footerBuildInfo').innerHTML = 
                    `${buildInfo.module_name} ${buildInfo.version} | ${buildInfo.go_runtime} | Built: ${new Date(buildInfo.build_time_utc).toLocaleDateString()}`;
                
                // Show version details
                document.getElementById('versionDetails').style.display = 'grid';
                document.getElementById('versionSummary').classList.remove('loading');
                
            } catch (error) {
                console.error('Error loading version info:', error);
                document.getElementById('versionSummary').innerHTML = '<span class="error">Error loading version information</span>';
            }
        }

        async function loadMQTTStatus() {
            try {
                const response = await fetch('/api/mqtt-status');
                if (!response.ok) throw new Error('Failed to fetch MQTT status');
                
                const data = await response.json();
                
                // Update MQTT status
                const statusEl = document.getElementById('mqttStatus');
                const indicator = statusEl.querySelector('.status-indicator');
                
                if (!data.enabled) {
                    indicator.className = 'status-indicator status-offline';
                    statusEl.innerHTML = '<span class="status-indicator status-offline"></span>Disabled';
                    document.getElementById('mqttBroker').textContent = 'N/A';
                    document.getElementById('mqttTopic').textContent = 'N/A';
                    document.getElementById('mqttInterval').textContent = 'N/A';
                    document.getElementById('mqttLastPublish').textContent = 'N/A';
                } else if (data.connected) {
                    indicator.className = 'status-indicator status-online';
                    statusEl.innerHTML = '<span class="status-indicator status-online"></span>Connected';
                    document.getElementById('mqttBroker').textContent = data.broker;
                    document.getElementById('mqttTopic').textContent = data.topic_prefix;
                    document.getElementById('mqttInterval').textContent = data.publish_interval + 's';
                    document.getElementById('mqttLastPublish').textContent = formatTimestamp(data.last_publish);
                } else {
                    indicator.className = 'status-indicator status-offline';
                    statusEl.innerHTML = '<span class="status-indicator status-offline"></span>Disconnected';
                    document.getElementById('mqttBroker').textContent = data.broker || 'N/A';
                    document.getElementById('mqttTopic').textContent = data.topic_prefix || 'N/A';
                    document.getElementById('mqttInterval').textContent = (data.publish_interval || 0) + 's';
                    document.getElementById('mqttLastPublish').textContent = 'Never';
                }
                
            } catch (error) {
                console.error('Error loading MQTT status:', error);
                document.getElementById('mqttStatus').innerHTML = '<span class="status-indicator status-unknown"></span>Error';
            }
        }

        async function loadHealthInfo() {
            try {
                const response = await fetch('/health');
                if (!response.ok) throw new Error('Failed to fetch health info');
                
                const data = await response.json();
                
                // Update monitor data status based on freshness
                if (data.monitor_data && data.monitor_data.fresh) {
                    // Data is fresh, show positive status
                    const secondsAgo = data.monitor_data.seconds_ago;
                    document.getElementById('systemUptime').innerHTML = `
                        <span class="status-indicator status-online"></span>
                        ${formatDuration(secondsAgo)} ago
                    `;
                }
                
            } catch (error) {
                console.error('Error loading health info:', error);
            }
        }

        // Update uptime every 30 seconds
        function updateUptime() {
            if (versionData && versionData.build_info) {
                const startTime = new Date(versionData.build_info.start_time);
                const uptime = Math.floor((new Date() - startTime) / 1000);
                document.getElementById('uptime').textContent = formatDuration(uptime);
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            // Load all information
            loadVersionInfo();
            loadMQTTStatus();
            loadHealthInfo();
            
            // Update MQTT status every 30 seconds
            setInterval(loadMQTTStatus, 30000);
            
            // Update uptime every 30 seconds
            setInterval(updateUptime, 30000);
            
            // Refresh health info every minute
            setInterval(loadHealthInfo, 60000);
        });
    </script>
</body>
</html>

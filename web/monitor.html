<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar System Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
        }
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .last-update {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .wide-card {
            grid-column: 1 / -1;
        }
        .card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255,255,255,0.18);
        }
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .metric:last-child { border-bottom: none; }
        .metric-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        .power-value { color: #e74c3c; }
        .energy-value { color: #3498db; }
        .percentage-value { color: #27ae60; }
        .status-online { color: #27ae60; }
        .status-offline { color: #e74c3c; }
        .solar-position {
            position: relative;
            height: 200px;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 50%, #90EE90 50%, #90EE90 100%);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .sun {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 20px #FFD700;
            transition: all 0.3s ease;
        }
        .inverter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .inverter-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .inverter-serial {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .inverter-power {
            font-size: 1.3em;
            font-weight: bold;
            color: #e74c3c;
        }
        .inverter-status {
            margin-top: 8px;
            font-size: 0.8em;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }
        .flow-item {
            text-align: center;
            flex: 1;
        }
        .flow-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .flow-arrow {
            color: #3498db;
            font-size: 1.5em;
            margin: 0 10px;
        }
        
        /* Production Chart Styles */
        .chart-container {
            margin: 20px 0;
            height: 300px;
            position: relative;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chart-controls select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-bar {
            width: 12px;
            height: 12px;
            background: #3498db;
        }
        .legend-line {
            width: 20px;
            height: 2px;
            background: #e74c3c;
        }
        .chart-canvas {
            width: 100%;
            height: 220px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 5px;
        }
        .stat-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .inverter-grid { grid-template-columns: 1fr 1fr; }
            .chart-header { flex-direction: column; gap: 10px; }
            .chart-controls { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåû Solar System Monitor</h1>
            <div class="last-update" id="lastUpdate">Loading...</div>
        </div>

        <!-- Daily Production Chart -->
        <div class="card wide-card">
            <h3>üìä Daily Production</h3>
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Hourly Production Comparison</div>
                    <div class="chart-controls">
                        <select id="dateSelector">
                            <option value="">Today</option>
                        </select>
                        <select id="previousDateSelector">
                            <option value="">Yesterday</option>
                        </select>
                    </div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-bar"></div>
                        <span>Current Day</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line"></div>
                        <span>Previous Day</span>
                    </div>
                </div>
                <canvas class="chart-canvas" id="productionChart" width="800" height="220"></canvas>
                <div class="chart-stats" id="chartStats">
                    <div class="stat-item">
                        <div class="stat-value" id="todayTotal">-- kWh</div>
                        <div class="stat-label">Today Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="yesterdayTotal">-- kWh</div>
                        <div class="stat-label">Previous Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="todayPeak">-- W</div>
                        <div class="stat-label">Today Peak</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="efficiency">--%</div>
                        <div class="stat-label">vs Previous</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Current Production -->
            <div class="card">
                <h3>‚ö° Current Production</h3>
                <div class="metric">
                    <span class="metric-label">Power Output</span>
                    <span class="metric-value power-value" id="currentWatts">-- W</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Today's Energy</span>
                    <span class="metric-value energy-value" id="todayWh">-- Wh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Lifetime Energy</span>
                    <span class="metric-value energy-value" id="lifetimeWh">-- MWh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">7-Day Energy</span>
                    <span class="metric-value energy-value" id="sevenDaysWh">-- kWh</span>
                </div>
            </div>

            <!-- Solar Position -->
            <div class="card">
                <h3>‚òÄÔ∏è Solar Position</h3>
                <div class="solar-position" id="solarPosition">
                    <div class="sun" id="sunPosition"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Elevation</span>
                    <span class="metric-value" id="elevation">--¬∞</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Azimuth</span>
                    <span class="metric-value" id="azimuth">--¬∞</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Sunrise / Sunset</span>
                    <span class="metric-value" id="sunriseSunset">-- / --</span>
                </div>
            </div>

            <!-- Power Flow -->
            <div class="card">
                <h3>üîÑ Power Flow</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <div class="flow-icon">‚òÄÔ∏è</div>
                        <div class="metric-value power-value" id="pvWatts">-- W</div>
                        <div style="font-size: 0.8em; color: #7f8c8d;">Solar</div>
                    </div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-item">
                        <div class="flow-icon">üè†</div>
                        <div class="metric-value power-value" id="loadWatts">-- W</div>
                        <div style="font-size: 0.8em; color: #7f8c8d;">Load</div>
                    </div>
                    <div class="flow-arrow">‚áÑ</div>
                    <div class="flow-item">
                        <div class="flow-icon">üîå</div>
                        <div class="metric-value power-value" id="gridWatts">-- W</div>
                        <div style="font-size: 0.8em; color: #7f8c8d;">Grid</div>
                    </div>
                </div>
                <div class="metric" id="storageRow" style="display: none;">
                    <span class="metric-label">üîã Battery</span>
                    <span class="metric-value">
                        <span class="power-value" id="storageWatts">-- W</span>
                        (<span class="percentage-value" id="storageSOC">--%</span>)
                    </span>
                </div>
            </div>

            <!-- System Summary -->
            <div class="card">
                <h3>üìä System Summary</h3>
                <div class="metric">
                    <span class="metric-label">System Efficiency</span>
                    <span class="metric-value percentage-value" id="systemEfficiency">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Self Consumption</span>
                    <span class="metric-value percentage-value" id="selfConsumption">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Solar Coverage</span>
                    <span class="metric-value percentage-value" id="solarCoverage">--%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Inverters</span>
                    <span class="metric-value" id="activeInverters">-- / --</span>
                </div>
            </div>
        </div>

        <!-- Inverters -->
        <div class="card">
            <h3>üîß Inverter Status</h3>
            <div class="inverter-grid" id="inverterGrid">
                <div class="loading">Loading inverter data...</div>
            </div>
        </div>
    </div>

    <script>
        let lastUpdateTime = 0;
        let productionChart = null;
        let availableDates = [];

        function formatWatts(watts) {
            if (watts >= 1000000) return (watts / 1000000).toFixed(2) + ' MW';
            if (watts >= 1000) return (watts / 1000).toFixed(1) + ' kW';
            return Math.round(watts) + ' W';
        }

        function formatWh(wh) {
            if (wh >= 1000000) return (wh / 1000000).toFixed(2) + ' MWh';
            if (wh >= 1000) return (wh / 1000).toFixed(1) + ' kWh';
            return Math.round(wh) + ' Wh';
        }

        function formatPercentage(value) {
            if (isNaN(value)) return '--';
            return Math.round(value * 10) / 10 + '%';
        }

        // Production Chart Functions
        function initializeChart() {
            const canvas = document.getElementById('productionChart');
            const ctx = canvas.getContext('2d');
            
            productionChart = {
                canvas: canvas,
                ctx: ctx,
                data: {
                    current: [],
                    previous: []
                }
            };

            canvas.addEventListener('mousemove', handleChartMouseMove);
            canvas.addEventListener('mouseleave', handleChartMouseLeave);
        }

        function drawChart(currentDay, previousDay) {
            const chart = productionChart;
            const ctx = chart.ctx;
            const canvas = chart.canvas;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / 24;

            // Find max value for scaling
            let maxValue = 0;
            if (currentDay && currentDay.hourly_data) {
                maxValue = Math.max(maxValue, ...currentDay.hourly_data.map(h => h.production || 0));
            }
            if (previousDay && previousDay.hourly_data) {
                maxValue = Math.max(maxValue, ...previousDay.hourly_data.map(h => h.production || 0));
            }
            maxValue = Math.max(maxValue, 1); // Prevent division by zero

            // Draw grid lines
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight * i) / 5;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                const value = maxValue * (1 - i / 5);
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(formatWh(value), padding - 5, y + 4);
            }
            
            // Vertical grid lines (every 4 hours)
            for (let hour = 0; hour <= 24; hour += 4) {
                const x = padding + (hour * barWidth);
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                // X-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(hour + ':00', x, canvas.height - padding + 15);
            }

            // Draw current day bars
            if (currentDay && currentDay.hourly_data) {
                ctx.fillStyle = '#3498db';
                currentDay.hourly_data.forEach((hourData, hour) => {
                    if (hourData.production > 0) {
                        const barHeight = (hourData.production / maxValue) * chartHeight;
                        const x = padding + hour * barWidth + 2;
                        const y = canvas.height - padding - barHeight;
                        const width = barWidth - 4;
                        
                        ctx.fillRect(x, y, width, barHeight);
                    }
                });
            }

            // Draw previous day line
            if (previousDay && previousDay.hourly_data) {
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                let firstPoint = true;
                previousDay.hourly_data.forEach((hourData, hour) => {
                    if (hourData.production > 0) {
                        const x = padding + hour * barWidth + barWidth / 2;
                        const y = canvas.height - padding - (hourData.production / maxValue) * chartHeight;
                        
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                });
                ctx.stroke();
                
                // Draw points on the line
                ctx.fillStyle = '#e74c3c';
                previousDay.hourly_data.forEach((hourData, hour) => {
                    if (hourData.production > 0) {
                        const x = padding + hour * barWidth + barWidth / 2;
                        const y = canvas.height - padding - (hourData.production / maxValue) * chartHeight;
                        
                        ctx.beginPath();
                        ctx.arc(x, y, 3, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                });
            }

            // Store data for mouse interactions
            chart.data.current = currentDay ? currentDay.hourly_data : [];
            chart.data.previous = previousDay ? previousDay.hourly_data : [];
            chart.maxValue = maxValue;
            chart.padding = padding;
            chart.barWidth = barWidth;
            chart.chartHeight = chartHeight;
        }

        function handleChartMouseMove(event) {
            const canvas = productionChart.canvas;
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Calculate which hour we're hovering over
            const hour = Math.floor((x - productionChart.padding) / productionChart.barWidth);
            
            if (hour >= 0 && hour < 24) {
                showTooltip(event, hour);
            }
        }

        function handleChartMouseLeave() {
            hideTooltip();
        }

        function showTooltip(event, hour) {
            let tooltip = document.getElementById('chartTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'chartTooltip';
                tooltip.style.cssText = `
                    position: absolute;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1000;
                    max-width: 200px;
                `;
                document.body.appendChild(tooltip);
            }

            const current = productionChart.data.current[hour];
            const previous = productionChart.data.previous[hour];

            let content = `<strong>${hour}:00 - ${hour + 1}:00</strong><br>`;
            
            if (current && current.production > 0) {
                content += `Today: ${formatWh(current.production)}<br>`;
                content += `Power: ${formatWatts(current.power)}<br>`;
            } else {
                content += `Today: No data<br>`;
            }

            if (previous && previous.production > 0) {
                content += `Previous: ${formatWh(previous.production)}`;
            } else {
                content += `Previous: No data`;
            }

            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('chartTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function updateChartStats(currentDay, previousDay) {
            const todayTotal = currentDay ? currentDay.total_wh : 0;
            const yesterdayTotal = previousDay ? previousDay.total_wh : 0;
            const todayPeak = currentDay ? currentDay.peak_watts : 0;
            
            document.getElementById('todayTotal').textContent = formatWh(todayTotal);
            document.getElementById('yesterdayTotal').textContent = formatWh(yesterdayTotal);
            document.getElementById('todayPeak').textContent = formatWatts(todayPeak);
            
            let efficiency = 0;
            if (yesterdayTotal > 0) {
                efficiency = ((todayTotal - yesterdayTotal) / yesterdayTotal) * 100;
            }
            
            const efficiencyEl = document.getElementById('efficiency');
            efficiencyEl.textContent = (efficiency >= 0 ? '+' : '') + efficiency.toFixed(1) + '%';
            efficiencyEl.style.color = efficiency >= 0 ? '#27ae60' : '#e74c3c';
        }

        function updateDateSelectors(availableDates) {
            const dateSelector = document.getElementById('dateSelector');
            const previousDateSelector = document.getElementById('previousDateSelector');
            
            // Clear existing options except first
            while (dateSelector.children.length > 1) {
                dateSelector.removeChild(dateSelector.lastChild);
            }
            while (previousDateSelector.children.length > 1) {
                previousDateSelector.removeChild(previousDateSelector.lastChild);
            }

            // Add available dates
            availableDates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = formatDateForDisplay(date);
                dateSelector.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = formatDateForDisplay(date);
                previousDateSelector.appendChild(option2);
            });
        }

        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (dateStr === today.toISOString().split('T')[0]) {
                return 'Today';
            } else if (dateStr === yesterday.toISOString().split('T')[0]) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
                });
            }
        }

        async function fetchProductionData() {
            try {
                const dateSelector = document.getElementById('dateSelector');
                const previousDateSelector = document.getElementById('previousDateSelector');
                
                const params = new URLSearchParams();
                if (dateSelector.value) params.append('date', dateSelector.value);
                if (previousDateSelector.value) params.append('previous', previousDateSelector.value);

                const response = await fetch('/api/daily-production?' + params.toString());
                if (!response.ok) throw new Error('Failed to fetch production data');

                const data = await response.json();
                
                // Update available dates if changed
                if (JSON.stringify(data.available_dates) !== JSON.stringify(availableDates)) {
                    availableDates = data.available_dates || [];
                    updateDateSelectors(availableDates);
                }

                // Update chart
                drawChart(data.current_day, data.previous_day);
                updateChartStats(data.current_day, data.previous_day);

            } catch (error) {
                console.error('Error fetching production data:', error);
                // Show error in chart area
                const ctx = productionChart.ctx;
                ctx.clearRect(0, 0, productionChart.canvas.width, productionChart.canvas.height);
                ctx.fillStyle = '#e74c3c';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Error loading production data', 
                    productionChart.canvas.width / 2, 
                    productionChart.canvas.height / 2);
            }
        }

        function updateSolarPosition(position) {
            const sun = document.getElementById('sunPosition');
            const container = document.getElementById('solarPosition');
            
            // Convert elevation and azimuth to x,y position
            const maxElevation = 90;
            const elevationPercent = Math.max(0, position.elevation) / maxElevation;
            
            // Azimuth: 0¬∞ = North, 90¬∞ = East, 180¬∞ = South, 270¬∞ = West
            // Convert to screen coordinates (0¬∞ = top, 90¬∞ = right)
            const azimuthRadians = (position.azimuth - 90) * Math.PI / 180;
            
            const containerRect = container.getBoundingClientRect();
            const centerX = containerRect.width / 2;
            const centerY = containerRect.height - 15; // Near bottom when elevation is 0
            
            const radius = Math.min(centerX, containerRect.height) * 0.8;
            const x = centerX + (radius * elevationPercent * Math.cos(azimuthRadians)) - 15;
            const y = centerY - (radius * elevationPercent * Math.sin(azimuthRadians)) - 15;
            
            sun.style.left = Math.max(0, Math.min(containerRect.width - 30, x)) + 'px';
            sun.style.top = Math.max(0, Math.min(containerRect.height - 30, y)) + 'px';
            
            // Update sun opacity based on elevation
            sun.style.opacity = position.is_daytime ? '1' : '0.3';
            
            document.getElementById('elevation').textContent = position.elevation.toFixed(1) + '¬∞';
            document.getElementById('azimuth').textContent = position.azimuth.toFixed(1) + '¬∞';
            document.getElementById('sunriseSunset').textContent = position.sunrise + ' / ' + position.sunset;
        }

        function updateInverters(inverters) {
            const grid = document.getElementById('inverterGrid');
            
            if (!inverters || inverters.length === 0) {
                grid.innerHTML = '<div class="error">No inverter data available</div>';
                return;
            }
            
            grid.innerHTML = '';
            
            inverters.forEach(inverter => {
                const card = document.createElement('div');
                card.className = 'inverter-card';
                
                const isActive = inverter.current_watts > 0;
                const statusClass = isActive ? 'status-online' : 'status-offline';
                const statusText = isActive ? 'Active' : 'Idle';
                
                card.innerHTML = `
                    <div class="inverter-serial">${inverter.serial}</div>
                    <div class="inverter-power">${formatWatts(inverter.current_watts)}</div>
                    <div class="inverter-status ${statusClass}">${statusText}</div>
                    <div style="font-size: 0.7em; color: #7f8c8d; margin-top: 5px;">
                        Max: ${formatWatts(inverter.max_watts)}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        async function fetchData() {
            try {
                const response = await fetch('/api/monitor');
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                // Check if data is newer
                const dataTime = new Date(data.timestamp).getTime();
                if (dataTime <= lastUpdateTime) return;
                lastUpdateTime = dataTime;
                
                // Update production data
                document.getElementById('currentWatts').textContent = formatWatts(data.production.current_watts);
                document.getElementById('todayWh').textContent = formatWh(data.production.today_wh);
                document.getElementById('lifetimeWh').textContent = formatWh(data.production.lifetime_wh);
                document.getElementById('sevenDaysWh').textContent = formatWh(data.production.seven_days_wh);
                
                // Update power flow
                document.getElementById('pvWatts').textContent = formatWatts(data.power_flow.pv_watts);
                document.getElementById('loadWatts').textContent = formatWatts(data.power_flow.load_watts);
                
                const gridWatts = data.power_flow.grid_watts;
                const gridElement = document.getElementById('gridWatts');
                if (gridWatts > 0) {
                    gridElement.textContent = '‚Üì ' + formatWatts(gridWatts);
                    gridElement.style.color = '#e74c3c'; // Import - red
                } else if (gridWatts < 0) {
                    gridElement.textContent = '‚Üë ' + formatWatts(-gridWatts);
                    gridElement.style.color = '#27ae60'; // Export - green
                } else {
                    gridElement.textContent = formatWatts(0);
                    gridElement.style.color = '#7f8c8d'; // Neutral
                }
                
                // Storage data
                if (data.power_flow.storage_watts !== 0 || data.power_flow.storage_soc > 0) {
                    document.getElementById('storageRow').style.display = 'flex';
                    document.getElementById('storageWatts').textContent = formatWatts(data.power_flow.storage_watts);
                    document.getElementById('storageSOC').textContent = formatPercentage(data.power_flow.storage_soc);
                }
                
                // Update summary
                document.getElementById('systemEfficiency').textContent = formatPercentage(data.summary.system_efficiency);
                document.getElementById('selfConsumption').textContent = formatPercentage(data.summary.self_consumption);
                document.getElementById('solarCoverage').textContent = formatPercentage(data.summary.solar_coverage);
                document.getElementById('activeInverters').textContent = 
                    data.summary.active_inverters + ' / ' + data.summary.total_inverters;
                
                // Update solar position
                updateSolarPosition(data.solar_position);
                
                // Update inverters
                updateInverters(data.inverters);
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = 
                    'Last updated: ' + new Date(data.timestamp).toLocaleTimeString();
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('lastUpdate').textContent = 
                    'Error: ' + error.message + ' (retrying...)';
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            
            // Set up event listeners for date selectors
            document.getElementById('dateSelector').addEventListener('change', fetchProductionData);
            document.getElementById('previousDateSelector').addEventListener('change', fetchProductionData);

            // Initial load
            fetchData();
            fetchProductionData();
            
            // Update every 30 seconds for live data
            setInterval(fetchData, 30000);
            
            // Update production chart every 5 minutes
            setInterval(fetchProductionData, 5 * 60000);
        });
    </script>
</body>
</html>